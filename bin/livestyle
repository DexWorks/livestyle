#!/usr/bin/env node

/*jslint nomen:false */
/*global require, __dirname */
var express = require('express'),
    util = require('util'),
    fs = require('fs'),
    path = require('path'),
    app = express.createServer(),
    mappings = {},
    optimist = require('optimist')
    commandLineOptions = optimist
        .usage('Usage: $0 [--proxy <remotehost> [--map <directoryMapping>]] [--host <hostname>] [-p <port>] documentRoot')
        .options('proxy', {
            describe: 'The remote host:port to serve non-CSS files from'
        })
        .options('host', {
            alias: 'h',
            default: '0.0.0.0',
            describe: 'The local hostname or IP-address to listen on'
        })
        .options('port', {
            alias: 'p',
            default: 3000,
            describe: 'The local post number to listen on'
        })
        .options('map', {
            alias: 'm',
            describe: 'Directory mappings of the form'
        })
        .check(function (argv) {
            if (argv.map) {
                (typeof argv.map === 'string' ? [argv.map] : argv.map).forEach(function (urlEqualsDir) {
                    var matchUrlEqualsDir = urlEqualsDir.match(/^([^=]+)=([^=]+)$/);
                    if (matchUrlEqualsDir) {
                        mappings[matchUrlEqualsDir[1]] = matchUrlEqualsDir[2];
                    } else {
                        throw 'Invalid --map syntax: ' + urlEqualsDir;
                    }
                });
            }
        })
        .argv,
    documentRoot = path.normalize(commandLineOptions._[0] || process.cwd());

if (commandLineOptions.help) {
    optimist.showHelp();
    process.exit();
}

app.configure(function () {
    app
        .use(express.logger())
        .use(require('../lib/middleware/injectLiveStyleScriptIncludeIntoHtml')())
        .use(express['static'](documentRoot))
        .use(express.errorHandler({dumpExceptions: true, showStack: true}));

    require('../lib/installLiveCssFileWatcherInServer')(app, {
        mappings: mappings,
        documentRoot: documentRoot
    }, require('socket.io'));
});

app.listen(commandLineOptions.port, commandLineOptions.host);

console.log('Serving static files from ' + documentRoot);
console.log('Listening to http://' + commandLineOptions.host + ':' + commandLineOptions.port + '/');
