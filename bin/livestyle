#!/usr/bin/env node

/*jslint nomen:false */
/*global require, __dirname */
var express = require('express'),
    util = require('util'),
    fs = require('fs'),
    path = require('path'),
    app = express.createServer(),
    optimist = require('optimist')
    commandLineOptions = optimist
        .usage('Usage: $0 [-h <remotehost>] [-l <localhost>] [-p <portNumber>] [-r <rewriterules>] publicDir')
        .options('h', {
            alias: 'host',
            describe: 'The remote host:port to serve non-CSS files from'
        })
        .options('l', {
            alias: 'listen',
            default: '0.0.0.0',
            describe: 'The local hostname or IP-address to listen on'
        })
        .options('p', {
            alias: 'port',
            default: 3000,
            describe: 'The local post number to listen on'
        })
        .options('r', {
            alias: 'rewrite',
            describe: 'Rewrite rules on the form "regexp:replacement"'
        })
        .argv,
    publicDir = path.normalize(commandLineOptions._[0] || process.cwd());

if (commandLineOptions.help) {
    optimist.showHelp();
    process.exit();
}

app.configure(function () {
    app
        .use(express.logger())
        .use(require('../lib/middleware/injectLiveStyleScriptIncludeIntoHtml')())
        .use(express['static'](publicDir))
        .use(express.errorHandler({dumpExceptions: true, showStack: true}));

    require('../lib/installLiveCssFileWatcherInServer')(app, publicDir, require('socket.io'));
});

app.listen(commandLineOptions.p, commandLineOptions.l);

console.log('Serving static files from ' + publicDir);
console.log('Listening to http://' + commandLineOptions.l + ':' + commandLineOptions.p + '/');
