#!/usr/bin/env node

/*jslint nomen:false */
/*global require, __dirname */
var express = require('express'),
    util = require('util'),
    fs = require('fs'),
    path = require('path'),
    URL = require('url'),
    request = require('request'),
    app = express.createServer(),
    mappings = {},
    optimist = require('optimist'),
    commandLineOptions = optimist
        .usage('Usage: $0 [--proxy <remotehost> [-m <directoryMapping>]] [-h <hostname>] [-p <port>] documentRoot')
        .options('root', {
            alias: 'r',
            describe: 'The directory to serve static files from. Defaults to the current working directory unless --proxy is specified.'
        })
        .options('proxy', {
            describe: 'The remote host:port to serve non-CSS files from'
        })
        .options('map', {
            alias: 'm',
            describe: 'Directory mappings of the form: remoteDir=localDir where localDir is relative to documentRoot unless prefixed with /'
        })
        .options('host', {
            alias: 'h',
            default: '0.0.0.0',
            describe: 'The local hostname or IP-address to listen on'
        })
        .options('port', {
            alias: 'p',
            default: 3000,
            describe: 'The local post number to listen on'
        })
        .check(function (argv) {
            if (argv.map) {
                (typeof argv.map === 'string' ? [argv.map] : argv.map).forEach(function (urlEqualsDir) {
                    var matchUrlEqualsDir = urlEqualsDir.match(/^([^=]+)=([^=]+)$/);
                    if (matchUrlEqualsDir) {
                        mappings[matchUrlEqualsDir[1]] = matchUrlEqualsDir[2];
                    } else {
                        throw 'Invalid --map syntax: ' + urlEqualsDir;
                    }
                });
            }
        })
        .argv,
        documentRoot;

if (commandLineOptions.root) {
    documentRoot = path.resolve(process.cwd(), commandLineOptions.root);
} else if (!commandLineOptions.proxy) {
    documentRoot = process.cwd();
}

if (commandLineOptions.help) {
    optimist.showHelp();
    process.exit();
}

app.configure(function () {
    app
        .use(express.logger())
        .use(require('../lib/middleware/injectLiveStyleScriptIncludeIntoHtml')())
        .use(function (req, res, next) {
            Object.keys(mappings).forEach(function (url) {
                if (req.url.indexOf(url) === 0) {
                    console.log("rewriting ", req.url, "to", req.url.replace(url, mappings[url]));
                    req.url = req.url.replace(url, mappings[url]);
                }
            });
            next();
        });

    if (documentRoot) {
        console.log('Serving static files from ' + documentRoot);
        app.use(express['static'](documentRoot));
    }

    if (commandLineOptions.proxy) {
        var proxyUrl = URL.parse(commandLineOptions.proxy);
        console.log('Proxying to ' + proxyUrl.protocol + '//' + proxyUrl.host + '/');
        app.use(function (req, res, next) {
            request({
                method: req.method,
                url: proxyUrl.protocol + '//' + proxyUrl.host + req.url,
                onResponse: true
            }, function (err, response) {
                res.writeHead(response.statusCode, response.headers);
                response.pipe(res);
            });
        });
    }

    app.use(express.errorHandler({dumpExceptions: true, showStack: true}));

    require('../lib/installLiveCssFileWatcherInServer')(app, {
        documentRoot: documentRoot,
        mappings: mappings
    }, require('socket.io'));
});

app.listen(commandLineOptions.port, commandLineOptions.host);

console.log('Listening to http://' + commandLineOptions.host + ':' + commandLineOptions.port + '/');
